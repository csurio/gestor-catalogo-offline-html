<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestor de Cat√°logos ‚Äì Offline</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#334155; /* slate-600 */
      --text:#e5e7eb; /* gray-200 */
      --brand:#22c55e; /* green-500 */
      --accent:#38bdf8; /* sky-400 */
      --danger:#ef4444; /* red-500 */
      --card:#0b1224;
      --chip:#1e293b;
      --strike:#94a3b8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:linear-gradient(180deg, var(--bg), #050816);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(15,23,42,.8); backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid #1f2937; padding:12px 16px;
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    header h1{font-size:18px; margin:0; font-weight:700; letter-spacing:.2px}
    header .grow{flex:1}
    .btn{appearance:none; border:none; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:.15s transform ease,.15s background ease;}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-primary{background:var(--brand); color:#06220f}
    .btn-accent{background:var(--accent); color:#041018}
    .btn-ghost{background:#0b1224; color:#cbd5e1; border:1px solid #1f2937}
    .btn-danger{background:var(--danger); color:#fff}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}

    main{max-width:1200px; margin:20px auto; padding:0 16px 64px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px}
    .card h2{margin:0 0 8px; font-size:18px}
    .hint{color:#93a3b8; font-size:12px}
    label{display:block; font-size:13px; color:#a1a1aa; margin:12px 0 6px}
    input, textarea, select{width:100%; background:#0b1224; border:1px solid #1f2937; color:#e5e7eb; padding:10px 12px; border-radius:12px}
    textarea{min-height:84px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}

    .products{display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:12px}
    @media (max-width: 1100px){.products{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width: 640px){.products{grid-template-columns:1fr}}

    .product{position:relative; background:#0b1224; border:1px solid #1f2937; border-radius:16px; overflow:hidden; display:flex; flex-direction:column}
    .product img{width:100%; aspect-ratio:1/1; object-fit:cover; background:#0a0f1f}
    .product .pbody{padding:12px}
    .product h3{margin:0 0 6px; font-size:16px}
    .price{font-weight:800; font-size:18px}
    .price-line{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .oldprice{color:var(--strike); text-decoration:line-through}
    .discount-badge{background:#14532d; color:#bbf7d0; border:1px solid #166534; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700}
    .muted{color:#9aa9c3; font-size:12px}
    .chips{display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 0}
    .chip{background:var(--chip); color:#cbd5e1; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #1f2937}
    .product .actions{display:flex; gap:8px; padding:12px; border-top:1px solid #1f2937}

    .sold-overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none}
    .sold-overlay span{font-weight:900; font-size:38px; letter-spacing:4px; color:rgba(239,68,68,.22); transform:rotate(-18deg); border:4px solid rgba(239,68,68,.25); padding:8px 14px; border-radius:12px; backdrop-filter:blur(1px)}

    .viewer{margin-top:24px}
    .viewer .catalog-grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:12px}
    @media print {.no-print{display:none !important} body{background:white} main{margin:0} header{display:none}}
    @media print {.viewer .catalog-grid{grid-template-columns:repeat(2,1fr)} .product{border-color:#e5e7eb}}

    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:#0b1224; border:1px solid #1f2937}
    .switch{position:relative; width:42px; height:24px; background:#0b1224; border:1px solid #1f2937; border-radius:999px; cursor:pointer}
    .knob{position:absolute; top:2px; left:2px; width:18px; height:18px; background:#cbd5e1; border-radius:999px; transition:.2s}
    .switch[data-on="true"]{background:var(--brand); border-color:var(--brand)}
    .switch[data-on="true"] .knob{left:22px; background:#06220f}

    .brandbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .brandbar input{width:auto}
    .logo-preview{width:44px; height:44px; border-radius:12px; border:1px solid #1f2937; background:#0a0f1f; object-fit:cover}

    .sticky-footer{position:fixed; right:16px; bottom:16px; display:flex; gap:8px}
  </style>
</head>
<body>
  <header>
    <h1>üõí Gestor de Cat√°logos (local/offline)</h1>
    <div class="grow"></div>
    <div class="toolbar no-print">
      <button class="btn btn-ghost" id="btnImportJson">Importar JSON</button>
      <button class="btn btn-ghost" id="btnExportJson">Exportar JSON</button>
      <button class="btn btn-accent" id="btnStatic">Descargar Cat√°logo HTML</button>
      <button class="btn btn-primary" id="btnPrint">Exportar a PDF</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Informaci√≥n del cat√°logo</h2>
      <div class="hint">Estos datos aparecen en el encabezado de tu cat√°logo p√∫blico.</div>
      <div class="brandbar">
        <label class="pill">Nombre / Marca
          <input id="brandName" placeholder="Mi Emprendimiento" />
        </label>
        <label class="pill">WhatsApp
          <input id="brandPhone" placeholder="+503 7000-0000" />
        </label>
        <label class="pill">Correo
          <input id="brandEmail" placeholder="ventas@ejemplo.com" />
        </label>
        <label class="pill">Moneda
          <select id="currency">
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (‚Ç¨)</option>
            <option value="SVC">SVC (‚Ç°)</option>
            <option value="MXN">MXN ($)</option>
          </select>
        </label>
        <label class="pill">Logo
          <input id="brandLogo" type="file" accept="image/*" />
        </label>
        <img id="brandLogoPreview" class="logo-preview" alt="logo"/>
        <button class="btn btn-danger" id="btnClearLogo" title="Quitar logo">Quitar</button>
        <label class="pill">Mostrar agotados
          <span id="toggleSold" class="switch" role="switch" aria-checked="false"><span class="knob"></span></span>
        </label>
      </div>
    </section>

    <div class="grid">
      <section class="card">
        <h2>Agregar / Editar producto</h2>
        <div class="row">
          <div>
            <label>Nombre</label>
            <input id="pName" placeholder="Cartera de cuero" />
          </div>
          <div>
            <label>Categor√≠a (opcional)</label>
            <input id="pCategory" placeholder="Accesorios" />
          </div>
        </div>
        <div class="row3">
          <div>
            <label>Precio actual</label>
            <input id="pPrice" type="number" min="0" step="0.01" placeholder="19.99" />
          </div>
          <div>
            <label>Precio anterior</label>
            <input id="pOldPrice" type="number" min="0" step="0.01" placeholder="24.99" />
          </div>
          <div>
            <label>Descuento (%)</label>
            <input id="pDiscount" type="number" min="0" max="95" step="1" placeholder="20" />
          </div>
        </div>
        <div class="row3">
          <div>
            <label>Stock (existencias)</label>
            <input id="pStock" type="number" min="0" step="1" placeholder="10" />
          </div>
          <div>
            <label>Estado</label>
            <select id="pStatus">
              <option value="available">Disponible</option>
              <option value="sold">Vendido</option>
              <option value="hidden">Oculto</option>
            </select>
          </div>
          <div>
            <label>SKU (opcional)</label>
            <input id="pSku" placeholder="SKU-001" />
          </div>
        </div>
        <label>Descripci√≥n</label>
        <textarea id="pDesc" placeholder="Breve descripci√≥n del producto‚Ä¶"></textarea>
        <label>Foto (JPG/PNG) ‚Äì se optimiza autom√°ticamente</label>
        <input id="pImage" type="file" accept="image/*" />
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn btn-primary" id="btnAdd">Guardar producto</button>
          <button class="btn btn-ghost" id="btnClear">Limpiar</button>
        </div>
        <div class="hint" id="formHint"></div>
      </section>

      <section class="card">
        <h2>Productos</h2>
        <div class="row">
          <input id="search" placeholder="Buscar por nombre, categor√≠a o SKU‚Ä¶" />
          <select id="sort">
            <option value="newest">M√°s recientes</option>
            <option value="name">Nombre (A‚ÜíZ)</option>
            <option value="priceAsc">Precio (menor a mayor)</option>
            <option value="priceDesc">Precio (mayor a menor)</option>
          </select>
        </div>
        <div class="products" id="list"></div>
      </section>
    </div>

    <section class="card viewer">
      <h2>Vista p√∫blica del cat√°logo</h2>
      <div class="hint">As√≠ lo ver√°n tus clientes. Usa <b>Exportar a PDF</b> para generar un archivo listo para compartir.</div>

      <div id="publicHeader" style="margin:16px 0; display:flex; gap:14px; align-items:center; flex-wrap:wrap">
        <img id="vhLogo" class="logo-preview" alt="logo" style="display:none"/>
        <div style="font-size:22px; font-weight:800" id="vhBrand">Mi Emprendimiento</div>
        <div class="chip" id="vhPhone">üì± +503 7000-0000</div>
        <div class="chip" id="vhEmail">‚úâÔ∏è ventas@ejemplo.com</div>
      </div>

      <div class="catalog-grid" id="catalog"></div>
    </section>
  </main>

  <div class="sticky-footer no-print">
    <button class="btn btn-primary" id="btnPrint2">Imprimir / PDF</button>
  </div>

  <input id="hiddenFile" type="file" accept="application/json" style="display:none" />

  <script>
    // =============================
    // Utilidades y estado
    // =============================
    var $ = function(s){ return document.querySelector(s); };
    var listEl = $('#list');
    var catalogEl = $('#catalog');

    var state = {
      products: [],
      editingId: null,
      showSold: true,
      currency: 'USD',
      brand: { name:'', phone:'', email:'', logo:null }
    };

    var LS_KEY = 'offlineCatalog.v2'; // bump version para nuevos campos

    function load(){
      try{
        var raw = localStorage.getItem(LS_KEY);
        if(raw){
          var data = JSON.parse(raw);
          state.products = data.products||[];
          state.currency = data.currency||'USD';
          state.showSold = !!data.showSold;
          state.brand = data.brand||{name:'',phone:'',email:'',logo:null};
        } else {
          // intentar migrar desde v1 si existe
          var rawOld = localStorage.getItem('offlineCatalog.v1');
          if(rawOld){
            var old = JSON.parse(rawOld);
            state.products = (old.products||[]).map(function(p){
              p.oldPrice = p.oldPrice||null; p.discountPct = p.discountPct||0; p.stock = (typeof p.stock==='number')?p.stock:null; return p;
            });
            state.currency = old.currency||'USD';
            state.showSold = !!old.showSold;
            state.brand = old.brand||{name:'',phone:'',email:''};
            state.brand.logo = null;
          }
        }
      }catch(e){ console.warn('load error', e); }
    }
    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify({
        products: state.products,
        currency: state.currency,
        showSold: state.showSold,
        brand: state.brand
      }));
    }

    function fmtPrice(n){
      var map = { USD: {symbol:'$'}, EUR:{symbol:'‚Ç¨'}, SVC:{symbol:'‚Ç°'}, MXN:{symbol:'$'} };
      var sym = (map[state.currency] && map[state.currency].symbol) ? map[state.currency].symbol : '$';
      var num = Number(n||0);
      return sym + num.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
    }

    function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

    function clearForm(){
      state.editingId = null;
      $('#pName').value='';
      $('#pCategory').value='';
      $('#pPrice').value='';
      $('#pOldPrice').value='';
      $('#pDiscount').value='';
      $('#pStock').value='';
      $('#pStatus').value='available';
      $('#pSku').value='';
      $('#pDesc').value='';
      $('#pImage').value='';
      $('#formHint').textContent='';
      $('#btnAdd').textContent='Guardar producto';
    }

    function fileToDataUrl(file, max, cb, errCb){
      if(typeof max !== 'number'){ max = 1280; }
      var reader = new FileReader();
      reader.onerror = function(){ if(errCb) errCb('read_error'); };
      reader.onload = function(){
        var img = new Image();
        img.onerror = function(){ if(errCb) errCb('image_error'); };
        img.onload = function(){
          var scale = Math.min(1, max/Math.max(img.width,img.height));
          var w = Math.round(img.width*scale);
          var h = Math.round(img.height*scale);
          var canvas = document.createElement('canvas');
          var ctx = canvas.getContext('2d');
          canvas.width = w; canvas.height = h;
          ctx.drawImage(img,0,0,w,h);
          var dataUrl = canvas.toDataURL('image/jpeg', 0.82);
          if(cb) cb(dataUrl);
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    function normalizePricing(price, oldPrice, discountPct){
      var p = isFinite(price)? Number(price): 0;
      var op = isFinite(oldPrice)? Number(oldPrice): null;
      var d = isFinite(discountPct)? Number(discountPct): null;

      if(d!=null && (d<0 || d>95)) d = Math.max(0, Math.min(95, d));
      if(op!=null && op<=0) op = null;

      if(d!=null && (op==null || op<=p) && d>0){
        // calcular precio anterior a partir del descuento
        op = round2(p / (1 - d/100));
      } else if((d==null || d<=0) && op!=null && op>p){
        // calcular descuento a partir del precio anterior
        d = Math.round((1 - (p/op))*100);
      }
      if(op!=null && op<=p){ op = null; }
      if(d!=null && d<=0){ d = 0; }
      return { price: round2(p), oldPrice: op!=null? round2(op): null, discountPct: d!=null? d: 0 };
    }
    function round2(x){ return Math.round((Number(x)||0)*100)/100; }

    function onSave(){
      var name = ($('#pName').value||'').trim();
      var price = parseFloat($('#pPrice').value||'0');
      var oldPrice = parseFloat($('#pOldPrice').value||'');
      var discount = parseFloat($('#pDiscount').value||'');
      var category = ($('#pCategory').value||'').trim();
      var status = $('#pStatus').value;
      var stock = parseInt($('#pStock').value||'');
      var sku = ($('#pSku').value||'').trim();
      var desc = ($('#pDesc').value||'').trim();
      var file = ($('#pImage').files && $('#pImage').files[0]) ? $('#pImage').files[0] : null;

      if(!name){ return msg('El nombre es obligatorio'); }
      if(!(price>=0)){ return msg('Precio inv√°lido'); }

      var norm = normalizePricing(price, oldPrice, discount);

      // si el stock es 0 y no est√° oculto, marcar como vendido autom√°ticamente
      if(isFinite(stock) && stock<=0 && status!=='hidden'){ status = 'sold'; }

      function persist(imgData){
        if(state.editingId){
          var idx = -1;
          for(var i=0;i<state.products.length;i++){ if(state.products[i].id===state.editingId){ idx=i; break; } }
          if(idx>-1){
            var old = state.products[idx];
            state.products[idx] = {
              id: old.id,
              name: name,
              price: norm.price,
              oldPrice: norm.oldPrice,
              discountPct: norm.discountPct,
              stock: isFinite(stock)? Number(stock): null,
              category: category,
              status: status,
              sku: sku,
              desc: desc,
              image: (imgData || old.image),
              createdAt: old.createdAt,
              updatedAt: Date.now()
            };
          }
          msg('Producto actualizado');
        }else{
          state.products.unshift({
            id: uid(), name: name, price: norm.price, oldPrice: norm.oldPrice, discountPct: norm.discountPct,
            stock: isFinite(stock)? Number(stock): null,
            category: category, status: status, sku: sku, desc: desc,
            image: (imgData || null), createdAt: Date.now(), updatedAt: Date.now()
          });
          msg('Producto agregado');
        }
        save();
        render();
        clearForm();
      }

      if(file){
        fileToDataUrl(file, 1280, function(url){ persist(url); }, function(){ msg('No se pudo procesar la imagen'); });
      }else{
        persist(null);
      }
    }

    function msg(t){
      $('#formHint').textContent=t; setTimeout(function(){ $('#formHint').textContent=''; }, 2500);
    }

    function render(){
      // brand
      $('#vhBrand').textContent = state.brand.name||'Mi Emprendimiento';
      $('#vhPhone').textContent = state.brand.phone?('üì± '+state.brand.phone):'';
      $('#vhEmail').textContent = state.brand.email?('‚úâÔ∏è '+state.brand.email):'';
      $('#currency').value = state.currency;
      var toggle = document.getElementById('toggleSold');
      toggle.setAttribute('data-on', String(!!state.showSold));
      toggle.setAttribute('aria-checked', String(!!state.showSold));

      // Logo
      if(state.brand.logo){
        $('#brandLogoPreview').src = state.brand.logo; $('#vhLogo').src = state.brand.logo; $('#vhLogo').style.display='inline-block';
      } else {
        $('#brandLogoPreview').removeAttribute('src'); $('#vhLogo').style.display='none';
      }

      // filters
      var q = (($('#search').value||'').toLowerCase());
      var sort = $('#sort').value;

      var arr = state.products.slice();
      if(q){
        arr = arr.filter(function(p){
          return [p.name,p.category,p.sku].some(function(x){ return ((x||'').toLowerCase().indexOf(q) > -1); });
        });
      }
      if(!state.showSold){ arr = arr.filter(function(p){ return p.status!=="sold"; }); }

      if(sort==='name'){ arr.sort(function(a,b){ return String(a.name||'').localeCompare(String(b.name||'')); }); }
      else if(sort==='priceAsc'){ arr.sort(function(a,b){ return (a.price||0)-(b.price||0); }); }
      else if(sort==='priceDesc'){ arr.sort(function(a,b){ return (b.price||0)-(a.price||0); }); }
      else { arr.sort(function(a,b){ return (b.createdAt||0)-(a.createdAt||0); }); }

      // manage list (editor)
      var htmlList = '';
      for(var i=0;i<arr.length;i++){ htmlList += htmlProductCard(arr[i], true); }
      listEl.innerHTML = htmlList;

      // viewer grid
      var htmlGrid = '';
      for(var j=0;j<arr.length;j++){ if(arr[j].status!=='hidden'){ htmlGrid += htmlProductCard(arr[j], false); } }
      catalogEl.innerHTML = htmlGrid;

      // bind action buttons (editor cards)
      var edits = document.querySelectorAll('[data-action="edit"]');
      for(var e=0;e<edits.length;e++){
        edits[e].addEventListener('click', function(){
          var id = this.getAttribute('data-id');
          var p = null; for(var k=0;k<state.products.length;k++){ if(state.products[k].id===id){ p=state.products[k]; break; } }
          if(!p) return;
          state.editingId = id;
          $('#pName').value=p.name||'';
          $('#pCategory').value=p.category||'';
          $('#pPrice').value=p.price||'';
          $('#pOldPrice').value=p.oldPrice!=null?p.oldPrice:'';
          $('#pDiscount').value=p.discountPct||'';
          $('#pStock').value=(p.stock!=null)?p.stock:'';
          $('#pStatus').value=p.status||'available';
          $('#pSku').value=p.sku||'';
          $('#pDesc').value=p.desc||'';
          $('#btnAdd').textContent='Actualizar producto';
          window.scrollTo({top:0, behavior:'smooth'});
        });
      }
      var dels = document.querySelectorAll('[data-action="del"]');
      for(var d=0; d<dels.length; d++){
        dels[d].addEventListener('click', function(){
          var id = this.getAttribute('data-id');
          if(!confirm('¬øEliminar este producto?')) return;
          state.products = state.products.filter(function(x){ return x.id!==id; });
          save(); render();
        });
      }
      var toggles = document.querySelectorAll('[data-action="toggleSold"]');
      for(var t=0;t<toggles.length;t++){
        toggles[t].addEventListener('click', function(){
          var id = this.getAttribute('data-id');
          var p=null; for(var k=0;k<state.products.length;k++){ if(state.products[k].id===id){ p=state.products[k]; break; } }
          if(!p) return; p.status = (p.status==='sold'?'available':'sold'); p.updatedAt=Date.now();
          save(); render();
        });
      }
    }

    function priceLineHtml(p){
      var line = '<div class="price-line">';
      if(p.oldPrice!=null && p.oldPrice>p.price){ line += '<span class="oldprice">'+fmtPrice(p.oldPrice)+'</span>'; }
      line += '<span class="price">'+fmtPrice(p.price)+'</span>';
      if(p.discountPct && p.discountPct>0){ line += '<span class="discount-badge">-'+p.discountPct+'%</span>'; }
      line += '</div>';
      return line;
    }

    function htmlProductCard(p, editable){
      var desc = String(p.desc||'').slice(0,120);
      var sold = p.status==='sold';
      var hidden = p.status==='hidden';
      var statusChip = hidden? '<span class="chip">üôà Oculto</span>' : (sold? '<span class="chip">üî¥ Vendido</span>' : '<span class="chip">üü¢ Disponible</span>');
      var stockChip = (p.stock!=null)? (' <span class="chip">Stock: '+p.stock+'</span>') : '';
      var html = '';
      html += '<article class="product"'+(sold?' style="opacity:.8"':'')+'>';
      if(sold){ html += '<div class="sold-overlay"><span>VENDIDO</span></div>'; }
      html += '<img src="'+(p.image||placeholder())+'" alt="'+escapeHtml(p.name||'Producto')+'"/>';
      html += '<div class="pbody">';
      html += '<h3>'+escapeHtml(p.name||'')+'</h3>';
      html += priceLineHtml(p);
      if(p.category){ html += '<div class="muted">'+escapeHtml(p.category)+'</div>'; }
      html += '<div class="muted">'+escapeHtml(desc)+'</div>';
      html += '<div class="chips">'+statusChip+stockChip+(p.sku?(' <span class="chip">#'+escapeHtml(p.sku)+'</span>'):'')+'</div>';
      html += '</div>';
      if(editable){
        html += '<div class="actions">';
        html += '<button class="btn btn-ghost" data-action="edit" data-id="'+p.id+'">Editar</button>';
        html += '<button class="btn btn-danger" data-action="del" data-id="'+p.id+'">Eliminar</button>';
        html += '<button class="btn btn-accent" data-action="toggleSold" data-id="'+p.id+'">'+(p.status==='sold'?'Marcar disponible':'Marcar vendido')+'</button>';
        html += '</div>';
      }
      html += '</article>';
      return html;
    }

    function placeholder(){
      return 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="800" height="800">\n'+
        '<defs><linearGradient id="g" x1="0" x2="1"><stop offset="0%" stop-color="#0b1224"/><stop offset="100%" stop-color="#111827"/></linearGradient></defs>\n'+
        '<rect width="100%" height="100%" fill="url(#g)"/>\n'+
        '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8" font-family="Segoe UI, Roboto, Arial" font-size="28">Sin imagen</text>\n'+
        '</svg>'
      );
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, function(m){ return ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]); });
    }

    // =============================
    // Eventos de UI
    // =============================
    $('#brandName').addEventListener('input', function(e){ state.brand.name=e.target.value; save(); render(); });
    $('#brandPhone').addEventListener('input', function(e){ state.brand.phone=e.target.value; save(); render(); });
    $('#brandEmail').addEventListener('input', function(e){ state.brand.email=e.target.value; save(); render(); });
    $('#currency').addEventListener('change', function(e){ state.currency=e.target.value; save(); render(); });
    $('#toggleSold').addEventListener('click', function(){ state.showSold=!state.showSold; save(); render(); });

    $('#brandLogo').addEventListener('change', function(e){
      var f = (e.target.files && e.target.files[0])? e.target.files[0]: null; if(!f) return;
      fileToDataUrl(f, 512, function(url){ state.brand.logo = url; save(); render(); }, function(){ alert('No se pudo procesar el logo'); });
      e.target.value='';
    });
    $('#btnClearLogo').addEventListener('click', function(){ state.brand.logo=null; save(); render(); });

    $('#btnAdd').addEventListener('click', onSave);
    $('#btnClear').addEventListener('click', clearForm);

    $('#search').addEventListener('input', render);
    $('#sort').addEventListener('change', render);

    // Exportar / Importar JSON
    $('#btnExportJson').addEventListener('click', function(){
      var blob = new Blob([JSON.stringify({
        products: state.products, currency: state.currency, showSold: state.showSold, brand: state.brand
      }, null, 2)], {type:'application/json'});
      var a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = 'catalogo-'+new Date().toISOString().slice(0,10)+'.json';
      a.click(); URL.revokeObjectURL(a.href);
    });

    document.getElementById('btnImportJson').addEventListener('click', function(){
      document.getElementById('hiddenFile').click();
    });
    document.getElementById('hiddenFile').addEventListener('change', function(e){
      var file = (e.target.files && e.target.files[0]) ? e.target.files[0] : null; if(!file) return;
      var fr = new FileReader();
      fr.onload = function(){
        try{
          var data = JSON.parse(fr.result);
          state.products = (data.products||[]).map(function(p){
            p.oldPrice = (typeof p.oldPrice==='number')? p.oldPrice: null;
            p.discountPct = (typeof p.discountPct==='number')? p.discountPct: 0;
            p.stock = (typeof p.stock==='number')? p.stock: null;
            return p;
          });
          state.currency = data.currency||state.currency;
          state.showSold = !!data.showSold;
          state.brand = data.brand||state.brand;
          if(state.brand && !('logo' in state.brand)){ state.brand.logo = null; }
          save(); render(); alert('Cat√°logo importado.');
        }catch(err){ alert('Archivo inv√°lido.'); }
        e.target.value='';
      };
      fr.readAsText(file);
    });

    // Imprimir / PDF
    function doPrint(){ window.print(); }
    document.getElementById('btnPrint').addEventListener('click', doPrint);
    document.getElementById('btnPrint2').addEventListener('click', doPrint);

    // =============================
    // Exportar HTML EST√ÅTICO (sin <script>)
    // =============================
    document.getElementById('btnStatic').addEventListener('click', function(){
      var html = buildStaticHtml({
        products: state.products,
        currency: state.currency,
        brand: state.brand
      });
      var blob = new Blob([html], {type:'text/html'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      var safeName = (state.brand.name||'marca').replace(/[^a-z0-9_-]+/gi,'-');
      a.download = 'catalogo-'+safeName+'.html';
      a.click(); URL.revokeObjectURL(a.href);
    });

    function buildStaticHtml(data){
      var symMap = {USD:'$',EUR:'‚Ç¨',SVC:'‚Ç°',MXN:'$'};
      var SYM = symMap[data.currency] || '$';
      var brandName = data.brand && data.brand.name ? data.brand.name : '';
      var brandPhone = data.brand && data.brand.phone ? data.brand.phone : '';
      var brandEmail = data.brand && data.brand.email ? data.brand.email : '';
      var brandLogo = data.brand && data.brand.logo ? data.brand.logo : '';
      var esc = function(s){ return String(s||'').replace(/[&<>"']/g, function(m){ return ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]); }); };
      var placeholder = 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="800"><rect width="100%" height="100%" fill="#0b1224"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8" font-family="Segoe UI, Roboto, Arial" font-size="28">Sin imagen</text></svg>');

      var cards = '';
      for(var i=0;i<(data.products||[]).length;i++){
        var p = data.products[i]; if(p.status==='hidden') continue;
        var price = SYM + Number(p.price||0).toFixed(2);
        var oldp = (p.oldPrice!=null && p.oldPrice>p.price)? (SYM + Number(p.oldPrice||0).toFixed(2)) : '';
        var disc = (p.discountPct && p.discountPct>0)? ('<span class="discount-badge">-'+p.discountPct+'%</span>') : '';
        var statusChip = (p.status==='sold')? '<span class="chip">üî¥ Vendido</span>' : '<span class="chip">üü¢ Disponible</span>';
        var stockChip = (typeof p.stock==='number')? (' <span class="chip">Stock: '+p.stock+'</span>') : '';
        cards += "<article class='product'"+(p.status==='sold'?" style='opacity:.8'":'')+">"+
                 (p.status==='sold'?"<div class='sold-overlay'><span>VENDIDO</span></div>":'')+
                 "<img src='"+(p.image||placeholder)+"' alt='"+esc(p.name||'')+"'/>"+
                 "<div class='pbody'>"+
                 "<h3>"+esc(p.name||'')+"</h3>"+
                 "<div class='price-line'>"+(oldp?"<span class='oldprice'>"+oldp+"</span>":'')+"<span class='price'>"+price+"</span>"+disc+"</div>"+
                 (p.category?"<div class='muted'>"+esc(p.category)+"</div>":'')+
                 (p.desc?"<div class='muted'>"+esc(String(p.desc).slice(0,120))+"</div>":'')+
                 (p.sku?"<div class='muted'>#"+esc(p.sku)+"</div>":'')+
                 "<div class='chips'>"+statusChip+stockChip+"</div>"+
                 "</div></article>";
      }

      var chips = '';
      if(brandPhone){ chips += "<div class='chip'>üì± "+esc(brandPhone)+"</div>"; }
      if(brandEmail){ chips += "<div class='chip'>‚úâÔ∏è "+esc(brandEmail)+"</div>"; }
      var logoHtml = brandLogo? ("<img src='"+brandLogo+"' class='logo-preview' alt='logo' style='display:inline-block' />") : '';

      var html = ''+
      '<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"/>'+
      '<meta name="viewport" content="width=device-width,initial-scale=1"/>'+
      '<title>Cat√°logo ‚Äì '+esc(brandName)+'</title>'+
      '<style>'+ 
      'body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell, Noto Sans, Arial; background:#0f172a; color:#e5e7eb}'+
      '.wrap{max-width:1024px; margin:24px auto; padding:0 16px}'+
      '.hdr{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:16px}'+
      '.chip{background:#1e293b; border:1px solid #253145; padding:6px 10px; border-radius:999px; font-size:12px}'+
      '.logo-preview{width:44px; height:44px; border-radius:12px; border:1px solid #1f2937; background:#0a0f1f; object-fit:cover}'+
      '.grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}'+
      '@media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}'+
      '@media (max-width:600px){.grid{grid-template-columns:1fr}}'+
      '.product{position:relative; background:#0b1224; border:1px solid #1f2937; border-radius:16px; overflow:hidden}'+
      '.product img{width:100%; aspect-ratio:1/1; object-fit:cover; background:#0a0f1f}'+
      '.sold-overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none}'+
      '.sold-overlay span{font-weight:900; font-size:38px; letter-spacing:4px; color:rgba(239,68,68,.22); transform:rotate(-18deg); border:4px solid rgba(239,68,68,.25); padding:8px 14px; border-radius:12px; backdrop-filter:blur(1px)}'+
      '.pbody{padding:12px} .pbody h3{margin:0 0 6px; font-size:16px}'+
      '.muted{color:#9aa9c3; font-size:12px} .price{font-weight:800; font-size:18px}'+
      '.price-line{display:flex; align-items:center; gap:10px; flex-wrap:wrap}'+
      '.oldprice{color:#94a3b8; text-decoration:line-through}'+
      '.discount-badge{background:#14532d; color:#bbf7d0; border:1px solid #166534; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700}'+
      '@media print{.no-print{display:none}}'+
      '</style></head><body>'+
      '<div class="wrap">'+
      '<div class="hdr">'+logoHtml+'<div style="font-size:22px;font-weight:800">'+esc(brandName)+'</div>'+chips+'</div>'+
      '<div class="grid">'+cards+'</div>'+ 
      '<div class="no-print" style="margin-top:12px"><button onclick="window.print()">Imprimir / PDF</button></div>'+ 
      '</div></body></html>';
      return html;
    }

    // =============================
    // Mini test suite (no intrusivo)
    // =============================
    function runTests(){
      var results = [];
      try{ if(fmtPrice(10)==='$10.00'){ results.push('‚úî fmtPrice USD'); } else { results.push('‚úò fmtPrice USD'); } }catch(e){ results.push('‚úò fmtPrice USD threw'); }
      try{ var pp = normalizePricing(80, 100, null); if(pp.oldPrice===100 && pp.discountPct===20){ results.push('‚úî normalize old->disc'); } else { results.push('‚úò normalize old->disc'); } }catch(e){ results.push('‚úò normalize old->disc threw'); }
      try{ var pp2 = normalizePricing(80, null, 20); if(pp2.oldPrice && Math.abs(pp2.oldPrice-100)<0.01){ results.push('‚úî normalize disc->old'); } else { results.push('‚úò normalize disc->old'); } }catch(e){ results.push('‚úò normalize disc->old threw'); }
      try{ var html = buildStaticHtml({products:[{name:'A',price:80,oldPrice:100,discountPct:20,status:'sold'}], currency:'USD', brand:{name:'X'}}); if(html.indexOf('VENDIDO')>-1){ results.push('‚úî overlay vendido'); } else { results.push('‚úò overlay vendido'); } }catch(e){ results.push('‚úò overlay vendido threw'); }
      console.log('[Tests]', results.join(' | '));
      var hint = document.createElement('div'); hint.className='hint'; hint.textContent='Autotests: '+results.join(' | ');
      document.body.appendChild(hint); hint.style.position='fixed'; hint.style.left='12px'; hint.style.bottom='8px'; hint.style.opacity='0.6'; hint.classList.add('no-print');
      setTimeout(function(){ if(hint && hint.parentNode){ hint.parentNode.removeChild(hint); } }, 4000);
    }

    // init
    load();
    // hydrate inputs
    $('#brandName').value = state.brand.name||'';
    $('#brandPhone').value = state.brand.phone||'';
    $('#brandEmail').value = state.brand.email||'';
    render();
    runTests();
  </script>
</body>
</html>
